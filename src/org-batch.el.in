;; emacs org-mode batch configuration

;; local emacs extensions
(add-to-list 'load-path "%orgmode_path%")
;; in case we're using org-mode source repository
(add-to-list 'load-path "%orgmode_path%/lisp")
(add-to-list 'load-path "%orgmode_path%/contrib/lisp")

'(org-modules (quote (org-bbdb org-bibtex org-info org-jsinfo
                      org-irc org-w3m org-mouse org-eval
                      org-eval-light org-exp-bibtex org-man
                      org-mtags org-panel org-R
                      org-special-blocks org-exp-blocks)))

;;; ORG mode
(require 'org-install)
(require 'org-latex)
(require 'org-export-latex)
(require 'org-exp-blocks)
(require 'org-mtags)
(require 'htmlize)
; (require 'blorg)

;; set auto load on .org files
(add-to-list 'auto-mode-alist '("\\.org\\'" . org-mode))

;; org mode customisations
(setq org-export-htmlize-output-type 'css)

'(org-export-blocks (quote ((comment org-export-blocks-format-comment t)
			    (ditaa org-export-blocks-format-ditaa nil)
			    (dot org-export-blocks-format-dot t)
			    (r org-export-blocks-format-R nil)
			    (R org-export-blocks-format-R nil))))

'(org-export-html-inline-images t)
'(org-export-html-use-infojs t)

; html rendering
'(org-export-htmlize-output-type "css")
'(org-export-html-validation-link
  "<p class=\"xhtml-validation\"><a href=\"http://validator.w3.org/check?uri=referer\">Validate XHTML 1.0</a></p>")
'(org-export-html-with-timestamp nil)
'(org-export-html-style "<link rel=stylesheet href=\"style.css\" type=\"text/css\">")

; latex rendering
(setq org-export-latex-listings t)


(add-to-list 'org-export-latex-classes
	     '("book-1column" "\\documentclass[final,a4paper,10pt,onecolumn,twoside]{memoir}"
	       ("\\section{%s}" . "\\section*{%s}")
	       ("\\subsection{%s}" . "\\subsection*{%s}")
	       ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
	       ("\\paragraph{%s}" . "\\paragraph*{%s}")
	       ("\\subparagraph{%s}" . "\\subparagraph*{%s}"))
	     )

(add-to-list 'org-export-latex-classes
	     '("book-2column" "\\documentclass[final,a4paper,10pt,twocolumn,twoside]{memoir}"
	       ("\\section{%s}" . "\\section*{%s}")
	       ("\\subsection{%s}" . "\\subsection*{%s}")
	       ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
	       ("\\paragraph{%s}" . "\\paragraph*{%s}")
	       ("\\subparagraph{%s}" . "\\subparagraph*{%s}"))
	     )



(require 'org-publish)
(setq org-publish-project-alist
      '(
	("autorg-docs"
	 :base-directory "%autorg_path%/doc"
	 :base-extension "org"
	 :publishing-directory "%autorg_path%/pub/doc"
	 :recursive t
	 :publishing-function org-publish-org-to-html
	 :headline-levels 4             ; Just the default for this project.
	 :auto-preamble t
	 )

        ("autorg-pages"
	 :base-directory "%autorg_path%/org"
	 :base-extension "org"
	 :publishing-directory "%autorg_path%/pub"
	 :recursive t
	 :publishing-function org-publish-org-to-html
	 :headline-levels 4             ; Just the default for this project.
	 :auto-preamble t
	 )

        ;; ("org-static"
	;;  :base-directory "."
	;;  :base-extension "css\\|js\\|png\\|jpg\\|gif\\|pdf\\|mp3\\|ogg\\|swf"
	;;  :publishing-directory "../pub"
	;;  :recursive t
	;;  :publishing-function org-publish-attachment
	;;  )

        ("autorg" :components ("autorg-docs" "autorg-pages"))
	))

;;(org-publish-project "autorg")

;; publish the project given a string (in batch mode)
;; it's a replacement to org-publish function with the patch from
;; http://www.mail-archive.com/emacs-orgmode@gnu.org/msg25966.html
;; applied.
;;;###autoload
(defun org-publish-batch-project (project &optional force)
  "Publish PROJECT in batch mode."
  (interactive
   (list
    (assoc (org-icompleting-read
	    "Publish project: "
	    org-publish-project-alist nil t)
	   org-publish-project-alist)
    current-prefix-arg))
  (setq org-publish-initial-buffer (current-buffer))
  (save-window-excursion
    (let* ((org-publish-use-timestamps-flag
	    (if force nil org-publish-use-timestamps-flag)))
      (org-publish-projects
       (if (stringp project)
	   ;; If this function is called in batch mode,
	   ;; project is still a string here.
	   (list (assoc project org-publish-project-alist))
         (list project))))))
